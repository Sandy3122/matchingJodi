<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.1.0/mdb.min.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="https://i.postimg.cc/W1qxgjkZ/logo.jpg">
    <link rel="stylesheet" href="/css/employeeProfileStyle.css">
    <title>Profile Page</title>
</head>

<body>
    <section class="section about-section light-bg" id="about">
        <div class="container">
            <div class="row align-items-center flex-row-reverse">
                <div class="col-6">
                    <div class="about-text go-to">
                        <h3 class="dark-color">Welcome <span id="firstName"></span></h3>
                        <h6 class="theme-color lead">Role: <span id="role"></span></h6>
                        <div class="row about-list">
                            <div class="col-6">
                                <div class="media">
                                    <label>Birthday</label>
                                    <p id="birthday"></p>
                                </div>
                                <div class="media">
                                    <label>Age</label>
                                    <p id="age"></p>
                                </div>
                                <div class="media">
                                    <label>Marital Status</label>
                                    <p id="maritalStatus"></p>
                                </div>
                                <div class="media">
                                    <label>Gender</label>
                                    <p id="gender"></p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="media">
                                    <label>E-mail</label>
                                    <p id="email"></p>
                                </div>
                                <div class="media">
                                    <label>Phone</label>
                                    <p id="phoneNumber"></p>
                                </div>
                                <div class="media">
                                    <label>Emergency Phone</label>
                                    <p id="emergencyPhoneNumber"></p>
                                </div>
                                <div class="media">
                                    <label>Joining Date</label>
                                    <p id="joiningDate"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 text-center">
                    <div class="about-avatar" id="avatarContainer">
                        <img id="profilePic" src="" title="" alt="">
                    </div>
                </div>
            </div>
        </div>
    </section>
</body>
<!-- BootStrap CDN -->
<!-- MDB -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.1.0/mdb.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.20.0/pdf-lib.min.js"></script>
<script>
// profile.js
document.addEventListener('DOMContentLoaded', async function () {
    try {
        let token, userRole; // Define userRole variable
        if (sessionStorage.getItem("adminToken")) {
            token = sessionStorage.getItem('adminToken');
            userRole = 'admin'; // Assign userRole as admin
            console.log("Admin Role: ", userRole);
            console.log("Admin Token: ", token);
        } else if (sessionStorage.getItem("employeeToken")) {
            token = sessionStorage.getItem('employeeToken');
            userRole = 'employee'; // Assign userRole as employee
            console.log("Employee Role: ", userRole);
            console.log("Employee Token: ", token);
        }

        // Check if userRole is available
        if (!token || !userRole) {
            throw new Error('No token or role found.');
        }

        const response = await fetch('/api/profile', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch profile.');
        }

        

// Update DOM elements with user data based on userRole
if (userRole === 'admin') {
    const data = await response.json();
    const adminData = data.adminData;
    if (!adminData) {
        throw new Error('Admin data not found in response.');
    }
    console.log(adminData.role)
    // Display admin profile details
    document.getElementById('firstName').textContent = adminData.firstName;
    document.getElementById('role').textContent = adminData.role;
    document.getElementById('birthday').textContent = formatDate(adminData.birthday);
    document.getElementById('age').textContent = calculateAge(adminData.birthday);
    document.getElementById('maritalStatus').textContent = adminData.maritalStatus;
    document.getElementById('gender').textContent = adminData.gender;
    document.getElementById('email').textContent = adminData.email;
    document.getElementById('phoneNumber').textContent = adminData.phoneNumber;
    document.getElementById('emergencyPhoneNumber').textContent = adminData.emergencyPhoneNumber;
    document.getElementById('joiningDate').textContent = formatJoiningDate(adminData.joiningDate);
    document.getElementById('profilePic').src = 'https://img.freepik.com/premium-vector/businessman-avatar-cartoon-character-profile_18591-50139.jpg';
    // Add other admin-specific fields here
} else if (userRole === 'employee') {
    const data = await response.json();
    const employeeData = data.employeeData;
    if (!employeeData) {
        throw new Error('Employee data not found in response.');
    }
    console.log(employeeData.role);
    // Display employee profile details
    document.getElementById('firstName').textContent = employeeData.firstName;
    document.getElementById('role').textContent = employeeData.role;
    document.getElementById('birthday').textContent = formatDate(employeeData.birthday);
    document.getElementById('age').textContent = calculateAge(employeeData.birthday);
    document.getElementById('maritalStatus').textContent = employeeData.maritalStatus;
    document.getElementById('gender').textContent = employeeData.gender;
    document.getElementById('email').textContent = employeeData.email;
    document.getElementById('phoneNumber').textContent = employeeData.phoneNumber;
    document.getElementById('emergencyPhoneNumber').textContent = employeeData.emergencyPhoneNumber;
    document.getElementById('joiningDate').textContent = formatJoiningDate(employeeData.joiningDate);
    document.getElementById('profilePic').src = employeeData.photoUrl;
} else {
    // Handle invalid role
    console.error('Invalid user role:', userRole);
}

    } catch (error) {
        console.error('Error fetching profile:', error);
        // Handle error, e.g., display error message to the user
    }
});


// Function to calculate age based on date of birth
function calculateAge(dateOfBirth) {
    const dob = new Date(dateOfBirth);
    const ageDiff = Date.now() - dob.getTime();
    const ageDate = new Date(ageDiff); // miliseconds from epoch
    return Math.abs(ageDate.getUTCFullYear() - 1970);
}

// Function to format date as "Month Day, Year"
function formatDate(dateString) {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', options);
}

// Function to format joining date
function formatJoiningDate(joiningDateResponse) {
    // Check if the response is an object and contains the '_seconds' property
    if (typeof joiningDateResponse === 'object' && joiningDateResponse.hasOwnProperty('_seconds')) {
        // Extract the seconds part from the response
        const seconds = joiningDateResponse._seconds;

        // Convert seconds to milliseconds and create a Date object
        const date = new Date(seconds * 1000);

        // Format the date as "Month Day, Year" (e.g., "February 29, 2024")
        const formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

        return formattedDate;
    } else {
        return 'Invalid Date';
    }
}
</script>
</html>